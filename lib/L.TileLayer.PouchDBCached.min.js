HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,b,c){var d=this.toDataURL(b,c).split(",")[1];setTimeout(function(){for(var c=atob(d),e=c.length,g=new Uint8Array(e),h=0;h<e;h++)g[h]=c.charCodeAt(h);a(new Blob([g],{type:b||"image/png"}))})}});L.TileLayer.addInitHook(function(){this._db=this.options.useCache?new PouchDB("offline-tiles"):null});L.TileLayer.prototype.options.useCache=!1;L.TileLayer.prototype.options.saveToCache=!0;
L.TileLayer.prototype.options.useOnlyCache=!1;L.TileLayer.prototype.options.cacheFormat="image/png";L.TileLayer.prototype.options.cacheMaxAge=864E5;
L.TileLayer.include({createTile:function(a,b){var c=document.createElement("img");c.onerror=L.bind(this._tileOnError,this,b,c);this.options.crossOrigin&&(c.crossOrigin="");c.alt="";a=this.getTileUrl(a);this.options.useCache?this._db.get(a,{revs_info:!0},this._onCacheLookup(c,a,b)):(c.onload=L.bind(this._tileOnLoad,this,b,c),c.src=a);return c},_onCacheLookup:function(a,b,c){return function(d,f){return f?this._onCacheHit(a,b,f,c):this._onCacheMiss(a,b,c)}.bind(this)},_onCacheHit:function(a,b,c,d){this.fire("tilecachehit",
{tile:a,url:b});this._db.getAttachment(b,"tile").then(function(f){var e=URL.createObjectURL(f);Date.now()>c.timestamp+this.options.cacheMaxAge&&!this.options.useOnlyCache?(console.log("Tile is too old: ",b),this.options.saveToCache&&(a.onload=L.bind(this._saveTile,this,a,b,c._revs_info[0].rev,d)),a.crossOrigin="Anonymous",a.src=b,a.onerror=function(a){this.src=e}):(a.onload=L.bind(this._tileOnLoad,this,d,a),a.src=e)}.bind(this))},_onCacheMiss:function(a,b,c){this.fire("tilecachemiss",{tile:a,url:b});
this.options.useOnlyCache?(a.onload=L.Util.falseFn,a.src=L.Util.emptyImageUrl):(a.onload=this.options.saveToCache?L.bind(this._saveTile,this,a,b,void 0,c):L.bind(this._tileOnLoad,this,c,a),a.crossOrigin="Anonymous",a.src=b)},_saveTile:function(a,b,c,d){if(this.options.saveToCache){var f=document.createElement("canvas");f.width=a.naturalWidth||a.width;f.height=a.naturalHeight||a.height;f.getContext("2d").drawImage(a,0,0);var e=this.options.cacheFormat;f.toBlob(function(a){this._db.put({_id:b,_rev:c,
timestamp:Date.now()}).then(function(c){return this._db.putAttachment(b,"tile",c.rev,a,e)}.bind(this)).then(function(a){d&&d()}).catch(function(){d&&d()})}.bind(this),e)}},seed:function(a,b,c){if(this.options.useCache&&!(b>c)&&this._map){for(var d=[],f=b;f<=c;f++){var e=this._map.project(a.getNorthEast(),f),g=this._map.project(a.getSouthWest(),f);e=this._pxBoundsToTileRange(L.bounds([e,g]));for(g=e.min.y;g<=e.max.y;g++)for(var h=e.min.x;h<=e.max.x;h++){var k=new L.Point(h,g);k.z=f;d.push(this._getTileUrl(k))}}a=
{bbox:a,minZoom:b,maxZoom:c,queueLength:d.length};this.fire("seedstart",a);b=this._createTile();b._layer=this;this._seedOneTile(b,d,a);return this}},_createTile:function(){return document.createElement("img")},_getTileUrl:function(a){var b=a.z;this.options.zoomReverse&&(b=this.options.maxZoom-b);b+=this.options.zoomOffset;return L.Util.template(this._url,L.extend({r:this.options.detectRetina&&L.Browser.retina&&0<this.options.maxZoom?"@2x":"",s:this._getSubdomain(a),x:a.x,y:this.options.tms?this._globalTileRange.max.y-
a.y:a.y,z:this.options.maxNativeZoom?Math.min(b,this.options.maxNativeZoom):b},this.options))},_seedOneTile:function(a,b,c){if(b.length){this.fire("seedprogress",{bbox:c.bbox,minZoom:c.minZoom,maxZoom:c.maxZoom,queueLength:c.queueLength,remainingLength:b.length});var d=b.shift();this._db.get(d,function(f,e){e?this._seedOneTile(a,b,c):(a.onload=function(e){this._saveTile(a,d,null);this._seedOneTile(a,b,c)}.bind(this),a.crossOrigin="Anonymous",a.src=d)}.bind(this))}else this.fire("seedend",c)}});
